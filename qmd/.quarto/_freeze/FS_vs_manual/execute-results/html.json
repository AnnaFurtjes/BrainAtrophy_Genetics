{
  "hash": "2c208644997c51f61567a8dced2620f6",
  "result": {
    "markdown": "---\ntitle: \"FreeSurfer output vs. manual estimates\"\nformat: \n  html:\n    code-fold: true\nauthor: \"Anna Elisabeth Furtjes\"\ndate: \"06 June 2025\"\noutput: html\ndoi: 10.1101/2024.11.06.622274\n---\n\n\n------------------------------------------------------------------------\n\n\n\n\n\n\nHere we compare \n\n  1) whether the biased nature of eTIV affected LBA estimates by comparing LBA score (as used in paper from FS processing) against LBA scores from manually estimated ICV. The latter is only available in neuroimaging visit 1\n  \n  2) whether ICV, TBV and LBA estimates differ between FSv5 and FSv7\n  \n\n# Load packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\nlibrary(readxl)\nlibrary(ggplot2)\nlibrary(stringr)\nlibrary(ggpubr)\nlibrary(cowplot)\nlibrary(dplyr)\nlibrary(stringr)\n```\n:::\n\n\n# Define function\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_heatmap = function(dat = both[,c(\"ICV\",\"TBV\", \"diff\", \"ratio\", \"resid\")], axisNames = c(\"ICV\",\"TBV\",\"Difference\\nscore\",\"Ratio\\nscore\",\"Residual\\nscore\")){\n\n  # define function to obtain lower triangle\n  get_lower_tri<-function(cormat){\n    cormat[upper.tri(cormat)] <- NA\n    return(cormat)\n  }\n\n  # get correlation matrix for both samples together\n  cor = cor(dat, use = \"pairwise.complete.obs\")\n  cor = get_lower_tri(cor)\n  # melt matrix\n  melted = reshape2::melt(cor)\n  # get rounded value\n  melted$value_round = round(melted$value, digit = 2)\n  melted$distance0 = abs(melted$value)\n\n  # plot\n  library(ggplot2)\n\n  p = ggplot(data = melted)+\n    geom_point(aes(x = Var1, y = Var2, shape = value, fill = value, size = distance0), shape = 21, alpha = 0.7, colour = \"white\") +\n    scale_fill_gradient2(low = \"#82A0D8\", high = \"#8DDFCB\", mid = \"white\",\n   midpoint = 0, limit = c(-1,1), space = \"Lab\" ,name=\"Correlation\", guide = \"legend\")+\n    scale_size_continuous(range = c(1, 15), guide = \"none\")+\n    geom_text(aes(Var1, Var2, label = value_round), color = \"black\", size = 4)+\n    xlab(\"\")+\n    ylab(\"\")+\n    #ggtitle(\"Pearson's corelations\")+\n    scale_x_discrete(labels = axisNames)+\n    scale_y_discrete(labels = axisNames)+\n    guides(fill = \"none\")+\n    theme_bw()+\n    theme(panel.border = element_blank())\n\n  return(p)\n}\n```\n:::\n\n\n# Manual vs. Fs-based measures (v5.2)\n\n## Read in and format data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Read in and format the data\n###### NEUROIMAGING WAVE 1\n#------------------------------------------------------------------------------------\n# read in TBV as sum of \"TotalGrayVol\", \"Right.Cerebellum.White.Matter\", \"Left.Cerebellum.White.Matter\", \"CorticalWhiteMatterVol\"\norig = fread(paste0(STRADLdir, \"/LBC1936_crossNeuroWave1.txt\"))\nnames(orig)[grepl(\"ICVstand\", names(orig))] <- \"ICV_stand\"\nnames(orig)[grepl(\"TBVstand\", names(orig))] <- \"TBV_stand\"\nnames(orig)[grepl(\"CSFstand\", names(orig))] <- \"CSF_stand\"\n\ncols = c(\"lbc36no\", names(orig)[grepl(\"_stand\", names(orig))])\norig = orig[, ..cols]\n\nnames(orig)[grepl(\"_stand\", names(orig))] <- paste0(\"orig_\", names(orig)[grepl(\"_stand\", names(orig))])\n\n#--------------------------------------------------------------------------\n# in-house processing\n# read in home-brew version shared by Paul \nman = read_excel(paste0(MANdir, \"/Brain_ICV_threeMethods_forAnna.xlsx\"))\n# contain three sets of data: editedvol, fastvol, SSvol\nman = man[, c(\"lbc_no\", \"ICVeditedvol\", \"Brain_inhousevol\")]\n\nnames(man)[grepl(\"lbc\", names(man))] <- \"lbc36no\"\n\n# delete missing values \nman = man[complete.cases(man),]\n\n# remove any participants with TBV > ICV (1)\nman = man[man$ICVeditedvol > man$Brain_inhousevol,]\n\n# difference scores for each method\nman$inhouse_diff = man$ICVeditedvol - man$Brain_inhousevol\n\n# ratio scores for each method\nman$inhouse_ratio = man$Brain_inhousevol / man$ICVeditedvol\n\n# residual socres for each method\nmodel <- lm(Brain_inhousevol ~ ICVeditedvol, data = man)\nman$inhouse_resid = resid(model)\n\n# identify cols to standardise\ncols = names(man)[grepl(\"diff|ratio|resid\", names(man))]\nman[, cols] = scale(man[, cols])\n\nnames(man)[grepl(\"diff|ratio|resid\", names(man))] = paste0(names(man)[grepl(\"diff|ratio|resid\", names(man))], \"_stand\")\n\n# standardise TBv ad ICV\nman$inhouse_TBV_stand = scale(man$Brain_inhousevol)\nman$inhouse_ICV_stand = scale(man$ICVeditedvol)\n\n# keep columns of interest only\ncols = c(\"lbc36no\", names(man)[grepl(\"_stand\", names(man))])\nman = man[, cols]\n\n# merge all three\nall = merge(orig, man, by = \"lbc36no\")\n\n# add in manual CSF values I had to specifically apply for from Paul so they are saved in another document\n# using wave 2 as all others are also from first neuroimaging visit\ncsf <- fread(paste0(STRADLdir, \"/LBC1936_csf_manual.txt\"))\nnames(csf)[grepl(\"csf_mm3_w2\", names(csf))] <- \"CSF\"\ncsf$inhouse_CSF_stand <- scale(csf$CSF)[,1]\n\nall = merge(all, csf[,c(\"lbc36no\", \"inhouse_CSF_stand\")], by = \"lbc36no\")\n\n# re-calculate resid just in case participants got deleted\nmodel <- lm(orig_TBV_stand ~ orig_ICV_stand, data = all)\nall$orig_resid_stand = as.vector(scale(resid(model)))\n\nmodel <- lm(inhouse_TBV_stand ~ inhouse_ICV_stand, data = all)\nall$inhouse_resid_stand = as.vector(scale(resid(model)))\n```\n:::\n\n\n## Correlations across FS-based measures (v5) vs. manually-segmented\n\nOf particular interest is the correlation between the residual score from original FS processing and the manually estimated ICV, which indicates that the residual score is biased towards ICV (larger ICVs, larger LBA; r = 0.19).\n\n\n::: {.cell fig.dim='[8,8]'}\n\n```{.r .cell-code}\n# number of participants\nn = nrow(all)\n\n# plot correlations between atrophy measures\np = plot_heatmap(dat = all[,c(\"orig_ICV_stand\", \"inhouse_ICV_stand\", \"orig_TBV_stand\", \"inhouse_TBV_stand\", \"orig_CSF_stand\", \"inhouse_CSF_stand\", \"orig_diff_stand\", \"inhouse_diff_stand\", \"orig_ratio_stand\", \"inhouse_ratio_stand\",\"orig_resid_stand\", \"inhouse_resid_stand\")], \n                 axisNames = c(\"ICV\\n(FS)\", \"ICV\\n(manual)\", \"TBV\\n(FS)\", \"TBV\\n(manual)\", \"CSF\\n(FS)\", \"CSF\\n(manual)\", \"Difference score\\n(FS)\", \"Difference score\\n(manual)\", \"Ratio score\\n(FS)\", \"Ratio score\\n(manual)\", \"Residual score\\n(FS)\", \"Residual score\\n(manual)\"))+\n  ggtitle(paste0(\"LBC Wave 1\\n(N = \",n,\")\"))+\n  theme(axis.text.x = element_text(angle = 90))+\n  xlab(\"TBV, ICV, and LBA estimated with\\nFreeSurfer (FS) and manual segmentation (manual)\")+\n  ylab(\"TBV, ICV, and LBA estimated with\\nFreeSurfer (FS) and manual segmentation (manual)\")\np\n```\n\n::: {.cell-output-display}\n![](FS_vs_manual_files/figure-html/unnamed-chunk-3-1.png){width=768}\n:::\n\n```{.r .cell-code}\n#ggsave(paste0(printP,\"/phenotypic/FS_vs_manual.jpg\"), bg = \"white\",plot = p, width = 15, height = 15, units = \"cm\", dpi = 300)\n\ncor.test(all$orig_resid_stand, all$inhouse_ICV_stand)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n\tPearson's product-moment correlation\n\ndata:  all$orig_resid_stand and all$inhouse_ICV_stand\nt = 4.8493, df = 629, p-value = 1.564e-06\nalternative hypothesis: true correlation is not equal to 0\n95 percent confidence interval:\n 0.1134659 0.2639773\nsample estimates:\n      cor \n0.1898367 \n```\n:::\n:::\n\n\n\n## Compare regular FS processing with manual in-house estimation of TBV and ICV\n\n\n\n::: {.cell fig.dim='[8,8]'}\n\n```{.r .cell-code}\n# ICV\ncorICV = ggplot(data = all, aes(x = orig_ICV_stand, y = inhouse_ICV_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"Manual estimates\")+\n  xlab(\"FS processed estimates\")+\n  ggtitle(\"Intracranial volume\")+\n  theme(panel.border = element_blank())\n\n# TBV\ncorTBV = ggplot(data = all, aes(x = orig_TBV_stand, y = inhouse_TBV_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"Manual estimates\")+\n  xlab(\"FS processed estimates\")+\n  ggtitle(\"Total brain volume\")+\n  theme(panel.border = element_blank())\n\n# difference score\ncordiff = ggplot(data = all, aes(x = orig_diff_stand, y = inhouse_diff_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"Manual estimates\")+\n  xlab(\"FS processed estimates\")+\n  ggtitle(\"LBA: difference score\")+\n  theme(panel.border = element_blank())\n\n# ratio score\ncorratio = ggplot(data = all, aes(x = orig_ratio_stand, y = inhouse_ratio_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"Manual estimates\")+\n  xlab(\"FS processed estimates\")+\n  ggtitle(\"LBA: ratio score\")+\n  theme(panel.border = element_blank())\n\n# residual score\ncorresid = ggplot(data = all, aes(x = orig_resid_stand, y = inhouse_resid_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"Manual estimates\")+\n  xlab(\"FS processed estimates\")+\n  ggtitle(\"LBA: residual score\")+\n  theme(panel.border = element_blank())\n\np = plot_grid(cordiff, corratio, corresid, corICV, corTBV, nrow = 2)\np\n```\n\n::: {.cell-output-display}\n![](FS_vs_manual_files/figure-html/unnamed-chunk-4-1.png){width=768}\n:::\n\n```{.r .cell-code}\n#ggsave(paste0(printP,\"/phenotypic/cors_FS_vs_manual.jpg\"), bg = \"white\",plot = p, width = 21, height = 18, units = \"cm\", dpi = 300)\n```\n:::\n\n\n\n# FreeSurfer v5 vs. FreeSurfer v7\n\n## Read in and format data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# orig was already read in above\nv5 <- orig\nnames(v5) <- str_replace(names(v5), \"orig_\", \"v5_\")\n\nv7 <- fread(paste0(out, \"/LBC1936_TBV_ICV_Fsv7_Josprocessing.txt\"))\n\n# remove any participants with TBV > ICV (0)\nv7 = v7[v7$ICV > v7$TBV,]\n\n# this data has not been qc'd yet and there are a few extreme outliers in ICV\n# cut-off outliers  at 4SDs (2 participants)\nv7$v7_TBV_stand <- scale(v7$TBV)[,1]\nv7$v7_ICV_stand <- scale(v7$ICV)[,1]\n\n# sum(v7$v7_ICV_stand > 4 | v7$v7_ICV_stand < -4)\nv7 <- v7[v7$v7_ICV_stand <= 4 & v7$v7_ICV_stand >= -4,]\nv7$v7_ICV_stand <- scale(v7$ICV)[,1]\n\n\n# difference scores for each method\nv7$v7_diff = v7$ICV - v7$TBV\n\n# ratio scores for each method\nv7$v7_ratio = v7$TBV / v7$ICV\n\n\n# residual socres for each method\nmodel <- lm(TBV ~ ICV, data = v7)\nv7$v7_resid = resid(model)\n\n# identify cols to standardise\nv7$v7_diff_stand <- scale(v7$v7_diff)[,1]\nv7$v7_ratio_stand <- scale(v7$v7_ratio)[,1]\nv7$v7_resid_stand <- scale(v7$v7_resid)[,1]\n\n# keep columns of interest only\n#cols = c(\"lbc36no\", names(v7)[grepl(\"_stand\", names(v7))])\n#v7 = v7[, ..cols]\n\nboth = merge(v5, v7, by = \"lbc36no\")\n\n# there is one more participant whose brain fills 43% of the intracranial vault in v7 but has been identified to fill 70% in v5 data  which was manually edited in some cases (average 70% SD = 5%), part360489\n# Jo checked this mask in itksnap for me and confirmed that one cortical hemisphere has not successfully segmented \nboth <- both[both$v7_ratio > 0.5,]\n\n# re-calculate resid just in case participants got deleted\nmodel <- lm(v5_TBV_stand ~ v5_ICV_stand, data = both)\nboth$v5_resid_stand = as.vector(scale(resid(model)))\n\nmodel <- lm(v7_TBV_stand ~ v7_ICV_stand, data = both)\nboth$v7_resid_stand = as.vector(scale(resid(model)))\n```\n:::\n\n\n## Correlations across FSv5 -based measures vs. FSv7 -based measures\n\n\n\n\n::: {.cell fig.dim='[8,8]'}\n\n```{.r .cell-code}\n# number of participants\nn = nrow(both)\n\n# plot correlations between atrophy measures\np = plot_heatmap(dat = both[,c(\"v5_ICV_stand\", \n                               \"v7_ICV_stand\", \n                               \"v5_TBV_stand\",\n                               \"v7_TBV_stand\",\n                               \"v5_diff_stand\",\n                               \"v7_diff_stand\",\n                               \"v5_ratio_stand\",\n                               \"v7_ratio_stand\",\n                               \"v5_resid_stand\",\n                               \"v7_resid_stand\")], \n                 axisNames = c(\"ICV\\n(FSv5)\", \n                               \"ICV\\n(FSv7)\", \n                               \"TBV\\n(FSv5)\", \n                               \"TBV\\n(FSv7)\", \n                               \"Difference score\\n(FSv5)\", \n                               \"Difference score\\n(FSv7)\", \n                               \"Ratio score\\n(FSv5)\", \n                               \"Ratio score\\n(FSv7)\", \n                               \"Residual score\\n(FSv5)\",\n                               \"Residual score\\n(FSv7)\"))+\n  ggtitle(paste0(\"LBC Wave 1\\n(N = \",n,\")\"))+\n  theme(axis.text.x = element_text(angle = 90))+\n  xlab(\"TBV, ICV, and LBA estimated with\\nFreeSurfer v5 (FSv5) and FreeSurfer v7 (FSv7)\")+\n  ylab(\"TBV, ICV, and LBA estimated with\\nFreeSurfer v5 (FSv5) and FreeSurfer v7 (FSv7)\")\np\n```\n\n::: {.cell-output-display}\n![](FS_vs_manual_files/figure-html/unnamed-chunk-6-1.png){width=768}\n:::\n\n```{.r .cell-code}\n#ggsave(paste0(printP,\"/phenotypic/FSv5_vs_FSv7.jpg\"), bg = \"white\",plot = p, width = 15, height = 15, units = \"cm\", dpi = 300)\n```\n:::\n\n\n## Compare regular FS processing with manual in-house estimation of TBV and ICV\n\n\n\n::: {.cell fig.dim='[8,8]'}\n\n```{.r .cell-code}\n# ICV\ncorICV = ggplot(data = both, aes(x = v7_ICV_stand, y = v5_ICV_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"FreeSurfer v5\")+\n  xlab(\"FreeSurfer v7\")+\n  ggtitle(\"Intracranial volume\")+\n  theme(panel.border = element_blank())\n\n# TBV\ncorTBV = ggplot(data = both, aes(x = v7_TBV_stand, y = v5_TBV_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"FreeSurfer v5\")+\n  xlab(\"FreeSurfer v7\")+\n  ggtitle(\"Total brain volume\")+\n  theme(panel.border = element_blank())\n\n# difference score\ncordiff = ggplot(data = both, aes(x = v7_diff_stand, y = v5_diff_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"FreeSurfer v5\")+\n  xlab(\"FreeSurfer v7\")+\n  ggtitle(\"LBA: difference score\")+\n  theme(panel.border = element_blank())\n\n# ratio score\ncorratio = ggplot(data = both, aes(x = v7_ratio_stand, y = v5_ratio_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"FreeSurfer v5\")+\n  xlab(\"FreeSurfer v7\")+\n  ggtitle(\"LBA: ratio score\")+\n  theme(panel.border = element_blank())\n\n# residual score\ncorresid = ggplot(data = both, aes(x = v7_resid_stand, y = v5_resid_stand))+\n  geom_point(alpha = 0.2)+\n  stat_cor(method = \"pearson\", cor.coef.name = \"r\")+\n  geom_abline(slope = 1, intercept = 0, colour = \"black\", linetype = \"longdash\")+\n  theme_bw()+\n  geom_smooth(method='lm')+\n  ylab(\"FreeSurfer v5\")+\n  xlab(\"FreeSurfer v7\")+\n  ggtitle(\"LBA: residual score\")+\n  theme(panel.border = element_blank())\n\np = plot_grid(cordiff, corratio, corresid, corICV, corTBV, nrow = 2)\np\n```\n\n::: {.cell-output-display}\n![](FS_vs_manual_files/figure-html/unnamed-chunk-7-1.png){width=768}\n:::\n\n```{.r .cell-code}\n#ggsave(paste0(printP,\"/phenotypic/cors_v5_vs_v7.jpg\"), bg = \"white\",plot = p, width = 21, height = 18, units = \"cm\", dpi = 300)\n```\n:::",
    "supporting": [
      "FS_vs_manual_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}