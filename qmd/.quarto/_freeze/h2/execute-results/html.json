{
  "hash": "8372d8b79627435285fb399e011479a7",
  "result": {
    "markdown": "---\ntitle: \"SNP-heritability\"\nformat: \n  html:\n    code-fold: true\nauthor: \"Anna Elisabeth Furtjes\"\ndate: \"14 November 2024\"\noutput: html\ndoi: 10.1101/2024.11.06.622274\n---\n\n\n------------------------------------------------------------------------\n\n\n\n\n\nSNP-heritability for all phenotypes of interest was calculated in the [GCTA software](https://yanglab.westlake.edu.cn/software/gcta/#Overview).\n\nInput data was prepared using scripts for [phenotypic](UKB_neuro.html) and [genotype data](UKB_geneticQC.html). \n\nEnsure that the `resid_stand` variable was calculated in the subsample with non-missing data that is analysed in the GCTA analysis. \n\n\n## Make GRM\n\n::: {.cell}\n\n```{.bash .cell-code}\n#!/bin/bash\ncd $wd\n# using PLINK files with my own qc (N = 43392)\n# I'd been wondering whether to restrict SNPs for MAF > 0.4 (Andrew and Isy do that in the context of calculating Nhat because outlier estimates are more likely due to mismatches with reference data set)\n# However, I don't see how this would apply to this case\n# Also found this paper: https://www.nature.com/articles/ng.3941\n# Fig.4 shows that heritability estimates in a simulation are about the same in each of the presented MAF bins, even MAF bin 0.4-0.5 produces very similar estimates - decided not to exclude, especially since I already have more stringent cut-off and fewer SNPs than Gails processing\n\ngcta-1.94.1 \\\n--bfile $genotype/ukb_neuroimaging_brainAtrophy_GWASinput \\\n--autosome \\\n--make-grm \\\n--maf 0.01 \\\n--out $wd/UKB_neuroimagingN43392_MAF0.01\n```\n:::\n\n\n## Remove related individuals\n\nInput data here has already been screened for related individuals with greedyRelated in the genetic QC step, but GTCA will remove even more because it's stricter.\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n## identify genetically unrelated individuals\n# cut-off of 0.125 up to third-degree relatives\n# testing 0.025, 0.05, 0.1, 0.125\ngcta-1.94.1 \\\n--grm $wd/UKB_neuroimagingN43392_MAF0.01 \\\n--grm-singleton 0.125 \\\n--out unrelated_singleton0.125 \n\n## prune GRM for relatedness by using cut-off\n#cut=0.125\n\nfor cut in 0.025 0.05 0.1 0.125\ndo\ngcta-1.94.1 \\\n--grm $wd/UKB_neuroimagingN43392_MAF0.01 \\\n--grm-cutoff $cut \\\n--make-grm \\\n--out $wd/UKB_neuroimagingN43392_MAF0.01_unrelated${cut}\ndone\n```\n:::\n\n\n## REML\n\n### Adjust phenotypic variables\n\nThis step was introduced while testing the reml script because it runs much more efficiently when the phenotypes of interest have been adjusted for covariates prior to running reml. This was deliberately not done for the GWAS associations because we want to be able to interpret SNP effects in units of outcome phenotype (which does not apply to reml where we model a variance component for all SNPs simultaneously).\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(data.table)\n# prep input covar files in R\n# which need to be split into categorical and continuous traits\n covar = fread(\"UKB_covarGWAS.txt\")\n# Cols = c(\"FID\", \"IID\", \"xCoord\", \"yCoord\", \"zCoord\", paste0(\"PC\", 1:40))\n# qcovar = covar[, ..Cols]\n# Cols = c(\"FID\", \"IID\", \"assessmentMonth\",\"site\", \"array\", \"batch\")\n# bcovar = covar[, ..Cols]\n# write.table(qcovar, file = \"qcovar.gcta\", col.names = F, row.names = F, sep = \"\\t\", na = \"NA\")\n# write.table(bcovar, file = \"bcovar.gcta\", col.names = F, row.names = F, sep = \"\\t\", na = \"NA\")\n\n# require one pheno files for each trait: no header, columns are IID, FID, phenotypes\n# could use --mpheno option but it feels like I have more control when I do it separately\n dat = fread(\"UKB_CrossNeuroIDP_noOutliers.txt\")\n# it is recommended to adjust the phenotyped for age and sex effects and standardise them tp z-scores prior to REML analysis because for some traits, the variance in females is larger than in males which cannot be corrected by including the sex effect as a covariate in the REML analysis\n dat = merge(dat, covar, by = c(\"FID\", \"IID\")) \n\n# remove missing values for regression to run\ndat = dat[complete.cases(dat),]\n\n# restrict only to participants with clean genetic data\nkeep = fread(\"/CCACE_Shared/Anna_F/BrainAtrophy/data/GCTA_out/UKB_neuroimagingN43392_MAF0.01_unrelated0.025.grm.id\")\n\ndat = dat[dat$IID %in% keep$V1,]\n\n# build model \n\nfor(trait in c(\"TBVstand\", \"ICVstand\", \"CSFstand\", \"diff_stand\", \"ratio_stand\", \"resid_stand\")){\n  cov1 = paste0(\"age + sex + assessmentMonth + site + xCoord + yCoord + zCoord + array + batch +\")\n  cov2 = paste0(\"PC\", 1:40, collapse = \" + \")\n  \n  formula = paste0(trait , \" ~ \", cov1, cov2)\n  \n  model = lm(as.formula(formula), data = dat)\n  \n  pred = scale(resid(model))\n  \n  summary(pred)\n  \n  # merge data\n  colNames = names(dat)\n  both = cbind(dat,pred)\n  names(both) = c(colNames, paste0(trait, \"_adjusted\"))\n  \n  keep = c(\"FID\",\"IID\",paste0(trait, \"_adjusted\"))\n  \n  write.table(both[, ..keep], file = paste0(trait,\"_adjusted.pheno\"), col.names = F, row.names = F, sep = \"\\t\", na = \"NA\")\n}\n```\n:::\n\n\n### Run GCTA-REML\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n## the covar file must be split up into categorical and quantitative covariates\n## --covar indicates the categorical file, and --qcovar the quantitative files \n\ncut=0.025\n\nfor trait in TBVstand ICVstand CSFstand diff_stand ratio_stand resid_stand\ndo\n\ngcta-1.94.1 \\\n--reml \\\n--grm-bin $genotype/UKB_neuroimagingN43392_MAF0.01_unrelated${cut} \\\n--pheno $phenotype/${trait}_age_sex.pheno \\\n--reml-alg 0 \\\n--covar $phenotype/bcovar.gcta \\\n--qcovar $phenotype/qcovar.gcta \\\n--reml-lrt 1 \\\n--thread-num 10 \\\n--reml-maxit 200 \\\n--out $out/gcta_${trait}_unrelated${cut}\n\ndone\n```\n:::\n\n\n\n## SNP-by-age interactions\n\n\n::: {.cell}\n\n```{.bash .cell-code}\n#!/bin/bash\n\n# R\n# library(data.table)\n# setwd(\"/CCACE_Shared/Anna_F/BrainAtrophy/data\")\n# prep input covar files in R\n# covar = fread(\"UKB_covarGWAS.txt\")\n\n# save age variable as plain text file\n# write.table(covar[,c(\"FID\", \"IID\", \"age\")], file = \"UKB_age.gxe\", col.names = F, row.names = F, sep = \"\\t\", na = \"NA\")\n\n\n#### Here I am using the same script as in GCTA_reml_adjusted.sh only that I am including a gxe interaction term\n#### Chose to keep the phenotype residualised for age because we want to control for a main effect of age (so we're comparing people of similar ages), but then we're asking whether the there is a significant GxAge variance contribution to the toal phenotypic variance \n#### also changing --reml-lrt to 2 because I am assuming there are two genetic variance components included in the analysis (main genetic effect and then the gene environment effect)\n\ncut=0.025\n\ngcta-1.94.1 \\\n--reml \\\n--grm-bin $genotype/UKB_neuroimagingN43392_MAF0.01_unrelated${cut} \\\n--pheno $phenotype/${trait}_adjusted.pheno \\\n--reml-alg 0 \\\n--reml-lrt 2 \\\n--gxe $phenotype/UKB_age.gxe \\\n--thread-num 30 \\\n--reml-maxit 200 \\\n--out $out/gcta_${trait}_unrelated${cut}_GxAge\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}